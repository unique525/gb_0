<?php

/**
 * 投票调查前台生成类
 * @category iCMS
 * @package iCMS_Rules_Gen_Product
 * @author yanjiuyuan
 */
class VotePublicGen extends BasePublicGen implements IBasePublicGen
{

    /**
     * 引导方法
     * @return string 返回执行结果
     */
    public function GenPublic()
    {
        $result = "";

        $action = Control::GetRequest("a", "");
        switch ($action) {
            case "vote":
                $result = self::GenVote();
                break;
            case "vote_single":
                $result = self::GenVoteSingle();
                break;
            case "select_item_list":
                $result = self::GenSelectItemList();
                break;
            default:
                break;
        }

        return $result;
    }

    /**
     * 问卷提交
     * @return int  返回执行结果
     */
    private function GenVote() {
        if (!empty($_GET)) {
            session_start();
            $vote_id = intval(Control::GetRequest("vote_id", "0"));
            $sessionName = Control::GetRequest("sn","");
            $code = Control::GetRequest("check_code" . $vote_id,"");
            $voteCheckCode = $_SESSION[$sessionName];
            $createDate = date("Y-m-d H:i:s", time());
            $ipAddress = Control::GetIP();
            $agent = Control::GetOS() . "与" . Control::GetBrowser();
            $VotePublicData = new VotePublicData();
            $voteItemData = new VoteItemPublicData();
            $voteSelectItemData = new VoteSelectItemPublicData();
            $voteRecordData = new VoteRecordData();
            $nowDate = date("Y-m-d", time());
            $arrList = $VotePublicData->GetVoteRow($vote_id);
            $isCheckCode = $arrList['IsCheckCode'];
            if ($isCheckCode == "1") {//如果启用了验证码先做验证码判断
                if (empty($voteCheckCode) || empty($code) || $voteCheckCode != $code)
                    return Control::GetRequest("jsonpcallback","") . '({"result":"-5"})';
            }
            //销毁验证码session
            unset($_SESSION[$sessionName]);
            $voteCheckCode=null;
            //解析$_GET生成对应数组
            foreach ($_GET as $key1 => $value1) {
                if (strpos($key1, "voteselectitem") === 0) {
                    $voteItemId = str_ireplace("voteselectitem", "", $key1);
                    $allNum = 0;
                    $value1 = array_flip(array_flip($value1)); //删除掉重复的投票选项（对应非正常刷票）
                    foreach ($value1 as $value2) {
                        $allNum+=1;
                        $voteSelectItemId = $value2;
                        if (!self::IsBelongVoteId($vote_id, $voteItemId, $voteSelectItemId)) {//如果提交的题目id或选项id不属于vote_id，则报错返回。
                            return Control::GetRequest("jsonpcallback","") . '({"result":"-7"})';
                        }
                        $voteSelectItemIdArr[] = $voteSelectItemId;   //收集要提交的选项ID并组成数组
                        $voteRecordDetailArr[] = array("voteitemid" => $voteItemId, "voteselectitemid" => $voteSelectItemId);
                    }
                    $voteItemIdArr[] = array($voteItemId, $allNum);   //收集要提交的题目ID并组成数组
                }
            }
            //判断投票是否为空并反馈
            if ($voteItemIdArr == null) {
                return Control::GetRequest("jsonpcallback","") . '({"result":"-2"})';
            }
            $state = $arrList['State'];
            //判断投票是否停止
            if ($state != 0) {
                return Control::GetRequest("jsonpcallback","") . '({"result":"-3"})';
            }
            //判断投票是否在有效时间段内
            $beginDate = $arrList['BeginDate'];
            $endDate = $arrList['EndDate'];
            if (!(strtotime($createDate) > strtotime($beginDate) && strtotime($createDate) < strtotime($endDate))) {
                return Control::GetRequest("jsonpcallback","") . '({"result":"-4"})';
            }
            //判断每个投票项（多选）是不是符合最大选择数和最小选择数目限制
            $arrItemList = $voteItemData->GetListByVoteId($vote_id, 0);
            //$unMeetItemArr[] = array();
            foreach ($voteItemIdArr as $key => $value) {
                $voteItemId = $value[0];  //题目ID
                $voteItemAllCount = $value[1];    //题目所属票数总和
                foreach ($arrItemList as $key1 => $value1) {
                    if ($voteItemId == $value1['VoteItemId']) {
                        $VoteItemTitle = $value1['VoteItemTitle'];
                        $selectNumMin = $value1['SelectNumMin'];
                        $selectNumMax = $value1['SelectNumMax'];
                        if (($selectNumMin != '0' && $voteItemAllCount < $selectNumMin) || ($selectNumMax != '0' && $voteItemAllCount > $selectNumMax))
                            $unMeetItemArr[] = array("voteitemtitle" => $VoteItemTitle, "voteitemallcount" => $voteItemAllCount, "selectnummin" => $selectNumMin, "selectnummax" => $selectNumMax);
                    }
                }
            }
            if (count($unMeetItemArr) > 0) {
                $unMeetItemArr = json_encode($unMeetItemArr);
                return Control::GetRequest("jsonpcallback","") . '({"result":"-6","unmeetitemarr":' . $unMeetItemArr . '})';
            }
            //判断投票ip限制
            $getIpCount = $voteRecordData->GetIpCount($vote_id, $ipAddress, $nowDate);   //获取问卷相同IP的次数
            $maxIpNum = $VotePublicData->GetIpCount($vote_id);   //获取问卷同IP准许提交次数上限
            if ($getIpCount >= $maxIpNum) {
                return Control::GetRequest("jsonpcallback","") . '({"result":"-1","maxipnum":"' . $maxIpNum . '"})';   //限制问卷提交次数
            }
            $result = $VotePublicData->UpdateCount($vote_id);                              //投票提交
            $result = $voteItemData->UpdateCountBatch($voteItemIdArr);              //题目提交
            $result = $voteSelectItemData->UpdateCountBatch($voteSelectItemIdArr);  //选项提交
            $result = $voteRecordData->CreatVoteRecord($vote_id, $ipAddress, $agent, $createDate); //投票记录提交
            $voteRecordId = $result; //得到投票记录主表id
            $result = $voteRecordData->CreatVoteRecordDetailBatch($voteRecordId, $voteRecordDetailArr); //投票详细记录提交
            //返回页面响应结果
            if ($result == 1) {
                return Control::GetRequest("jsonpcallback","") . '({"result":"1","voterecordid":"' . $voteRecordId . '","maxipnum":"' . $maxIpNum . '"})';
            } else {
                return Control::GetRequest("jsonpcallback","") . '({"result":"-1","voterecordid":"' . $voteRecordId . '","maxipnum":"' . $maxIpNum . '"})';
            }
        }
    }

    /**
     * 单项问卷提交
     * @return array  返回执行结果
     */
    private function GenVoteSingle() {
        if (!empty($_GET)) {
            session_start();
            $vote_id = intval(Control::GetRequest("vote_id", "0"));
            $sessionName = Control::GetRequest("sn","");
            $code = Control::GetRequest("checkcode" . $vote_id,"");
            $voteCheckCode = $_SESSION[$sessionName];
            $voteItemId = intval(Control::GetRequest("voteitemid", "0"));
            $voteSelectItemId = intval(Control::GetRequest("voteselectitemid", "0"));
            $createDate = date("Y-m-d H:i:s", time());
            $ipAddress = Control::GetIP();
            $agent = Control::GetOS() . "与" . Control::GetBrowse();
            $VotePublicData = new VotePublicData();
            $voteItemData = new VoteItemPublicData();
            $voteSelectItemData = new VoteSelectItemPublicData();
            $voteRecordData = new VoteRecordData();
            $nowDate = date("Y-m-d", time());
            $voteSelectItemIdArr[] = $voteSelectItemId;   //收集要提交的选项ID并组成数组
            $voteRecordDetailArr[] = array("voteitemid" => $voteItemId, "voteselectitemid" => $voteSelectItemId);
            $voteItemIdArr[] = array($voteItemId, 1);   //收集要提交的题目ID并组成数组
            $arrList = $VotePublicData->GetVoteRow($vote_id);
            $isCheckCode = $arrList['IsCheckCode'];
            if ($isCheckCode == "1") {//如果启用了验证码先做验证码判断
                if (empty($voteCheckCode) || empty($code) || $voteCheckCode != $code)
                    return Control::GetRequest("jsonpcallback","") . '({"result":"-5"})';
            }
            //判断投票是否为空并反馈
            if ($voteItemIdArr == null) {
                return Control::GetRequest("jsonpcallback","") . '({"result":"-2"})';
            }
            //如果提交的题目id或选项id不属于vote_id，则报错返回。
            if (!self::IsBelongVoteId($vote_id, $voteItemId, $voteSelectItemId)) {
                return Control::GetRequest("jsonpcallback","") . '({"result":"-7"})';
            }
            $state = $arrList['State'];
            //判断投票是否停止
            if ($state != 0) {
                return Control::GetRequest("jsonpcallback","") . '({"result":"-3"})';
            }
            //判断投票是否在有效时间段内
            $beginDate = $arrList['BeginDate'];
            $endDate = $arrList['EndDate'];
            if (!(strtotime($createDate) > strtotime($beginDate) && strtotime($createDate) < strtotime($endDate))) {
                return Control::GetRequest("jsonpcallback","") . '({"result":"-4"})';
            }
            $getIpCount = $voteRecordData->GetIpCount($vote_id, $ipAddress, $nowDate);   //获取问卷相同IP的次数
            $maxIpNum = $VotePublicData->GetIpCount($vote_id);   //获取问卷同IP准许提交次数上限
            if ($getIpCount >= $maxIpNum) {
                return Control::GetRequest("jsonpcallback","") . '({"result":"-1","maxipnum":"' . $maxIpNum . '"})';   //限制问卷提交次数
            }
            $result = $VotePublicData->UpdateCount($vote_id);                              //投票提交
            $result = $voteItemData->UpdateCountBatch($voteItemIdArr);              //题目提交
            $result = $voteSelectItemData->UpdateCountBatch($voteSelectItemIdArr);  //选项提交
            $result = $voteRecordData->CreatVoteRecord($vote_id, $ipAddress, $agent, $createDate); //投票记录提交
            $voteRecordId = $result; //得到投票记录主表id
            $result = $voteRecordData->CreatVoteRecordDetailBatch($voteRecordId, $voteRecordDetailArr); //投票详细记录提交
            //投票详细记录提交
            //返回页面响应结果
            //返回页面响应结果
            if ($result == 1) {
                return Control::GetRequest("jsonpcallback","") . '({"result":"1","voterecordid":"' . $voteRecordId . '","maxipnum":"' . $maxIpNum . '"})';
            } else {
                return Control::GetRequest("jsonpcallback","") . '({"result":"-1","voterecordid":"' . $voteRecordId . '","maxipnum":"' . $maxIpNum . '"})';
            }
        }
    }

    /**
     * 获取题目选项列表
     * @return arr 返回数据集结果
     */
    public function GenSelectItemList() {
        $vote_id = Control::GetRequest("vote_id", 0);
        $votePublicData = new VotePublicData();
        $allItem = $votePublicData->GetSelectItemList($vote_id);       //获取问卷题目
        //计算百分比
        foreach ($allItem as $columnName => $columnValue) {
            $itemAdd = $columnValue["cviaddcount"];             //题目的加票
            $selectItemAdd = $columnValue["cvsiaddcount"];      //选项的加票
            unset($columnValue["cviaddcount"]);                 //去除数组中多余元素便于最后数组的组合提交处理
            unset($columnValue["cvsiaddcount"]);                //去除数组中多余元素便于最后数组的组合提交处理
            $columnValue["cvirecordallcount"]+=$itemAdd;        //题目的总票
            $columnValue["cvsirecordcount"]+=$selectItemAdd;    //选项的总票
            $voteItemCount = $columnValue["cvirecordcount"];
            $voteItemAllCount = $columnValue["cvirecordallcount"];
            $voteSelectItemCount = $columnValue["cvsirecordcount"];
            $voteSelectItemPer = 0;
            if ($voteItemAllCount != 0)
                $voteSelectItemPer = round($voteSelectItemCount / $voteItemAllCount, 2) * 100;    //计算选项的百分比
            $columnValue['voteselectitemper'] = $voteSelectItemPer;
            $tempArrList[] = $columnValue;
        }

        $tempArrList = json_encode($tempArrList);
        return Control::GetRequest("jsonpcallback","") . '({"result":' . $tempArrList . '})';
    }

    /**
     * 判断提交的每个题目选项合法性，是不是与题目ID对应
     * @param int $vote_id    投票ID
     * @param int $voteItemId    题目ID
     * @param int $voteSelectItemId    题目选项ID
     * @return string $result true为合法，false为非法
     */
    public function IsBelongVoteId($vote_id, $voteItemId, $voteSelectItemId) {
        $result = false;
        $votePublicData = new VotePublicData();
        $allItem = $votePublicData->GetSelectItemList($vote_id);
        foreach ($allItem as $columnValue) {
            $ItemId = $columnValue["VoteItemId"];
            $SelectItemId = $columnValue["VoteSelectItemId"];
            if ($ItemId == $voteItemId && $SelectItemId == $voteSelectItemId) {
                $result = true;
                break;
            }
        }
        return $result;
    }
}

?>
